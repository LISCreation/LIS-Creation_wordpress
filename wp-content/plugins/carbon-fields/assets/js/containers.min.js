window.carbon=window.carbon||{};(function(b){var a=window.carbon;a.containers.Model=Backbone.Model.extend({defaults:{error:false,visible:true,has_changes:false,classes:[],},initialize:function(){this.addClass(["carbon-container","carbon-container-"+this.get("type")])},addClass:function(e){if(!_.isArray(e)){e=[e]}var c=this.get("classes")||[];var d=_.union(c,e);if(d.length!==c.length){this.set("classes",d)}},validate:function(e,d){if(e.visible===false){return false}var f=false;var c=a.views[this.get("id")];if(!c){return}_.each(c.fieldsCollection.models,function(g){if(!g.isRequired()){return}if(g.isValid()){g.set("error",false)}else{g.set("error",true);f=true;return}});this.set("error",f);if(f){return carbon_containers_l10n.please_fill_the_required_fields}}});a.containers.View=Backbone.View.extend({events:{"click ul.carbon-tabs-nav a":"switchTab","switchToTab .carbon-tab":"switchTab"},templateVariables:{},initialize:function(){this.fieldsCollection=new a.fields.Collection(this.model.get("fields"));this.listenTo(this.fieldsCollection,"add",this.renderField);this.listenToOnce(this.fieldsCollection,"change:value",this.changeListener);this.listenTo(this.model,"change:visible",this.disableInputs);this.listenTo(this.model,"change:classes",this.updateClass);this.on("container:beforeRender",this.checkVisibility);this.on("container:rendered",this.afterRenderInit);this.on("container:rendered",this.setupTabs);this.on("propagate",function(c){this.eventPropagator(this.fieldsCollection,c)});this.on("layoutUpdated",this.addFieldRows);this.on("container:rendered form:invalid",this.onSaveAlert);this.on("container:rendered form:invalid",this.showFirstHightlithedFieldTab);this.on("form:valid",this.resetOnBeforeUnload);this.listenTo(this.model,"change:visible",this.toggleVisibility);this.toggleVisibility(this.model)},changeListener:function(c,d){this.model.set("has_changes",true)},checkVisibility:function(){this.model.set("visible",true)},toggleVisibility:function(c){var f=c.get("id");var e=c.get("visible");var d=a.views.main.$body.find("#"+f);d.toggle(e)},eventPropagator:function(g,f){var g=g.toJSON();for(var e=0;e<g.length;e++){var d=g[e].id;var c=a.views[d];if(!_.isUndefined(c)){c.trigger(f.type,f);c.trigger("propagate",f)}}},addFieldRows:function(){var c=this.$(":not(.carbon-fields-row) > .carbon-field.has-width:not(.carbon-subrow)");var g=this.$(":not(.carbon-fields-row) > .carbon-field.has-width.carbon-subrow:not(.carbon-Complex)");var f=this.$(":not(.carbon-fields-row) > .carbon-field.has-width.carbon-subrow.carbon-Complex");var e=new Array(c,g,f);var d=b();var j=0;var h=function(){if(d.length>0){d.wrapAll('<div class="carbon-fields-row"/>');d=b();j=0}};for(i=0;i<e.length;i++){e[i].each(function(){var l=this.className.match(/width-(\d+)/);var k=parseInt(l[1]);if(j+k>100){h()}j+=k;d=d.add(b(this));if(!b(this).next().hasClass("has-width")){h()}})}},disableInputs:function(c){if(!this.$el.is("fieldset")){return}var d=!c.get("visible");this.$el.attr("disabled",d)},updateClass:function(c){var d=c.get("classes");this.$el.closest(".carbon-container").addClass(d.join(" "))},showFirstHightlithedFieldTab:function(){this.$el.find(".carbon-highlight").first().closest(".carbon-tab").trigger("switchToTab")},onSaveAlert:function(){var d=this;var c=window.onbeforeunload||b.noop;window.onbeforeunload=function(){var e=d.model.get("has_changes");var g=g||{};var f=g.saveAlert?g.saveAlert:carbon_containers_l10n.changes_made_save_alert;if(e&&f){return f}return c()}},resetOnBeforeUnload:function(){window.onbeforeunload=null},render:function(){var h=this.model.get("type");var g=a.template("tabs");var f=a.template(h);var e=this.model.attributes.settings;var c=this.fieldsCollection.toJSON();var d={};var k,j;this.trigger("container:beforeRender");if(e.tabs){_.each(e.tabs,function(q,o){var n=[];var p;for(var m=0;m<q.length;m++){for(var l=0;l<c.length;l++){p=c[l];if(q[m]===p.name){n.push(p)}}}d[o]={id:o.toLowerCase().replace(/[^\w]+/g,"-"),fields:n}});_.map(d,function(l){k=_.extend(this.templateVariables,this.model.attributes,{container:this.model,fields:l.fields});l.html=f(k);return l},this);j=g({tabs:d})}else{this.templateVariables=_.extend(this.templateVariables,this.model.attributes,{container:this.model,fields:c});j=f(this.templateVariables)}this.$el.html(j);this.trigger("container:rendered");return this},afterRenderInit:function(){var c=this;this.fieldsCollection.each(function(d){c.fieldsCollection.trigger("add",d)})},setupTabs:function(){var c=this.$el.find(".carbon-tabs");if(c.length===0){return}var d=this.$(".carbon-tabs-nav li").map(function(){return b(this).offset().top});if(_.uniq(d).length>1){c.addClass("carbon-tabs-stacked")}if(!c.find("ul.carbon-tabs-nav li.active").length){c.find("ul.carbon-tabs-nav a:first").trigger("click")}},switchTab:function(g){var d=b(g.target);var h,f;if(d.is("a")){h=b(g.target).closest("li");f=h.index()}else{if(d.is(".carbon-tab")){f=d.index();h=d.closest(".carbon-tabs").find(".carbon-tabs-nav li:eq("+f+")")}}var c=b(".carbon-tab",this.$el);c.removeClass("active").eq(f).addClass("active");h.addClass("active").siblings().removeClass("active");g.preventDefault()},renderField:function(c){var g=this;var d=c.get("type");var f=c.get("id");var e=a.fields.View[d];if(_.isUndefined(e)){e=a.fields.View}a.views[f]=new e({el:"."+f,model:c});a.views[f].on("field:rendered layoutUpdated",function(){g.trigger("layoutUpdated")});a.views[f].render()},validateForm:function(j){var k=j.data;var e=b(j.currentTarget);var f=b(".carbon-error-required");var h=e.find("#publishing-action .spinner");var g=k.model.isValid();var d=k.model.validationError;h.addClass("is-active");if(g){k.trigger("form:valid");if(j.type==="click"){f.slideUp(function(){b(this).remove()})}}else{k.trigger("form:invalid");h.addClass("disabled");if(d){if(f.length){f.find("strong").text(d)}else{f=b('<div class="settings-error error hidden below-h2 carbon-error-required"><p><strong>'+d+"</strong></p></div>");var e=b("#wpbody-content > .wrap > :header:first");while(e.next("a").length>0){e=e.next("a")}f.insertAfter(e).show()}var c=b(".carbon-highlight :input:first");c.closest(".postbox").removeClass("closed");c.focus()}setTimeout(function(){if(e.is("#post")){e.find("#publish").removeClass("button-primary-disabled button-disabled disabled");e.find("#ajax-loading, #publishing-action .spinner").attr("style","")}h.removeClass("disabled");h.removeClass("is-active")},0);if(j.type==="click"){j.stopImmediatePropagation()}j.preventDefault()}}});a.containers.Collection=Backbone.Collection.extend({model:function(d,c){var e=a.containers.Model[d.type];if(_.isUndefined(e)){e=a.containers.Model}return new e(d,c)}});a.containers.Model.Post_Meta=a.containers.Model.extend({defaults:{page_template:"default",level:1,parent_id:null,post_format:null,terms:[]}});a.containers.View.Post_Meta=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);this.$form=this.$el.closest("form#post");this.$form.on("submit",null,this,this.validateForm);this.syncTemplate();this.syncParent();this.syncLevel();this.syncPostFormat();this.syncTaxonomy();this.listenTo(this.model,"change:page_template change:parent_id change:level change:post_format change:terms",this.checkVisibility)},syncTemplate:function(){var d=this;var c=b("select#page_template");c.on("change",function(f){var e=b(this).val();d.model.set("page_template",e)}).trigger("change")},syncParent:function(){var d=this;var c=b("select#parent_id");c.on("change",function(e){var f=parseInt(b(this).val());d.model.set("parent_id",f)}).trigger("change")},syncLevel:function(){var d=this;var c=b("select#parent_id");c.on("change",function(f){var e=b(this).find("option:checked").attr("class");var g=e?parseInt(e.match(/^level-(\d+)/)[1])+2:1;d.model.set("level",g)}).trigger("change")},syncPostFormat:function(){var d=this;var c=b('input[name="post_format"]');c.on("change",function(f){var e=b(this).is(":checked");var g=b(this).val();if(e){d.model.set("post_format",g)}}).trigger("change")},syncTaxonomy:function(){var h=this;var e=this.model.get("settings");var d=e.show_on.tax_slug;var c=e.show_on.tax_term_id;var f=b("#taxonomy-"+d);var g=b("#"+d+"checklist input");if(!d||!c||!f.length){return false}f.on("change",g.selector,function(n){var m=b(this).is(":checked");var j=parseInt(b(this).val());var l=h.model.get("terms");if(m){l.push(j)}else{var k=l.indexOf(j);if(k!==-1){l.splice(k,1)}}l=_.uniq(l);h.model.set("terms",l);h.model.trigger("change:terms")});g.trigger("change")},checkVisibility:function(c){var f=this;var d=this.model.get("settings");var e=true;_.each(d.show_on,function(m,k){if(!m||(_.isArray(m)&&_.isEmpty(m))){return}switch(k){case"template_names":var j=f.model.get("page_template");if(b.inArray(j,m)===-1){e=false}break;case"not_in_template_names":var j=f.model.get("page_template");if(b.inArray(j,m)!==-1){e=false}break;case"parent_page_id":var o=f.model.get("parent_id");if(o!=m){e=false}break;case"level_limit":var n=f.model.get("level");if(n!=m){e=false}break;case"post_formats":var h=f.model.get("post_format");if(b.inArray(h,m)===-1){e=false}break;case"tax_slug":var l=f.model.get("terms");var g=d.show_on.tax_term_id;if(b.inArray(g,l)===-1){e=false}break}});this.model.set("visible",e)}});a.containers.View.Comment_Meta=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);this.$form=this.$el.closest("form#post");this.$form.on("submit",null,this,this.validateForm)},});a.containers.View.Theme_Options=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);var c=this;this.$form=this.$el.closest("form#theme-options-form");this.$form.on("submit",null,this,this.validateForm);b(window).on("scroll",function(){c.positionActionPanel.apply(c)})},positionActionPanel:function(){var f=b("#postbox-container-1");var c=b("#wpadminbar").height()+10;var e=this.$el.offset().top-c;var d=b(window).scrollTop();if(d>=e){f.addClass("fixed").css("top",c)}else{f.removeClass("fixed")}},setupTabs:function(){var d=this.$el.find(".carbon-tabs");if(d.length===0){return}var e=d.find("ul.carbon-tabs-nav a");var f=window.location.hash.replace(/^#/,"");var c=e.filter(function(){return"!"+b(this).data("id")===f}).eq(0);if(!c.length){var c=e.eq(0)}c.trigger("click");a.containers.View.prototype.setupTabs.apply(this)},switchTab:function(f){a.containers.View.prototype.switchTab.apply(this,[f]);var c=b(f.target);var g;if(c.is("a")){g=c.closest("li")}else{if(c.is(".carbon-tab")){var d=c.index();g=c.closest(".carbon-tabs").find(".carbon-tabs-nav li:eq("+d+")")}}window.location.hash="!"+g.find("a:eq(0)").data("id")}});a.containers.Model.Term_Meta=a.containers.Model.extend({defaults:{level:0,}});a.containers.View.Term_Meta=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);var c=this;this.$editForm=this.$el.closest("form#edittag");this.$editForm.on("submit",null,this,this.validateForm);this.$addForm=this.$el.closest("form#addtag");this.$submitButton=this.$addForm.find("#submit");this.$submitButton.bindFirst("click",this,this.validateForm);a.views.main.$el.ajaxSuccess(function(){c.initMonitor.apply(c,arguments)});this.syncLevel();this.listenTo(this.model,"change:level",this.checkVisibility)},initMonitor:function(e,d,c){if(d.status!=200||!c.data.length){return}var f=this.model.get("id");if(c.data.indexOf("carbon_panel_"+f)!==-1){a.collections.containers.reset()}},syncLevel:function(){var d=this;var c=b("select#parent");c.on("change",function(f){var e=b(this).find("option:checked").attr("class");var g=e?parseInt(e.match(/^level-(\d+)/)[1])+2:1;d.model.set("level",g)}).trigger("change")},checkVisibility:function(d){var h=this;var e=this.model.get("settings");var f=true;var g=h.model.get("level");var c=e.show_on_level;if(!c){f=true}else{if(g!==c){f=false}}this.model.set("visible",f)},});a.containers.Model.User_Meta=a.containers.Model.extend({defaults:{role:null}});a.containers.View.User_Meta=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);this.$form=this.$el.closest("form#your-profile, form#createuser");this.$form.on("submit",null,this,this.validateForm);this.syncRole();this.listenTo(this.model,"change:role",this.checkVisibility)},syncRole:function(){var e=this;var d=b("select#role");var c=this.$el.data("profile-role");this.model.set("role",c);d.on("change",function(f){var g=b(this).val();e.model.set("role",g)})},checkVisibility:function(d){var h=this;var f=this.model.get("settings");var c=this.model.get("role");var e=f.show_on.role||[];var g=true;if(e.length&&b.inArray(c,e)===-1){g=false}this.model.set("visible",g)},toggleVisibility:function(c){var f=c.get("id");var e=c.get("visible");var d=a.views.main.$body.find("#"+f+"-wrapper");d.toggleClass("carbon-hidden",!e);d.removeClass("carbon-cloaked")}});a.containers.Model.Widget=a.containers.Model.extend({initialize:function(){a.containers.Model.prototype.initialize.apply(this);var d=this.cid;var c=this.get("fields");_.each(c,function(e){e.id=e.id+"-"+d;e.lazyload=false});this.set("fields",c)}});a.containers.View.Widget=a.containers.View.extend({initialize:function(){a.containers.View.prototype.initialize.apply(this);this.$submitButton=this.$el.closest("form").find('input[type="submit"]');this.$submitButton.off("click",this.validateForm).on("click",null,this,this.validateForm)}})}(jQuery));