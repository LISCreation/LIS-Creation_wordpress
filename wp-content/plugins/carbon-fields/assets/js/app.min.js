window.carbon=window.carbon||{};(function(b){var a=window.carbon;a.main={};a.views={};a.lazyload={};a.collections={};a.containers={};a.fields={};a.main.View=Backbone.View.extend({el:document,initialize:function(){var c=this;this.$body=this.$("body");this.$body.addClass("carbon-fields");if(!this.$body.is(".mobile")){this.$body.addClass("carbon-desktop")}if(("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch){this.$body.addClass("touchscreen")}this.containersCollection=a.collections.containers=new a.containers.Collection;this.listenTo(this.containersCollection,"reset",this.setContainers);this.listenTo(this.containersCollection,"add",this.renderContainer);this.sidebarsCollection=a.collections.sidebars=new Backbone.Collection(carbon_json.sidebars);this.listenTo(this.sidebarsCollection,"add remove",function(e,h,f){var g=f.add?"add":"remove";var d=e.get("name");if(typeof a.sidebarManager!=="undefined"){a.sidebarManager(d,g)}});this.$("div.widgets-sortables, .meta-box-sortables").on("sortstart sortstop",function(e,f){var d=b(f.item).attr("id")||"";if(d.indexOf("widget-")===0){var d=d.replace(/widget-\d+_/,"")}if(d&&!_.isUndefined(a.views[d])){a.views[d].trigger("propagate",e)}});this.$el.on("widget-added widget-updated",function(){c.widgetsHandler.apply(c,arguments)});this.$("#update-nav-menu").on("click",".menu-item-edit-inactive .item-edit",function(d){c.navMenuHandler.apply(c,arguments)});this.on("app:rendered",function(){setTimeout(this.lazyload,0);setInterval(this.lazyload,1000)})},setContainers:function(){this.containersCollection.set(carbon_json.containers);this.trigger("app:rendered")},renderContainer:function(d){var e=d.get("type");var f=d.get("id");var c=a.containers.View[e];if(_.isUndefined(c)){c=a.containers.View}a.views[f]=new c({el:".container-"+f,model:d});a.views[f].render()},widgetsHandler:function(i,j){var f=b(j).attr("id");var c=f.replace(/widget-\d+_/,"");var d=b(j).find(".container-"+c).data("json");if(!d){return}var h=b.parseJSON(a.urldecode(d));if(i.type==="widget-updated"){var g=a.views[c];var e=g.model;g.undelegateEvents();g.$el.removeData().unbind();this.containersCollection.remove(e);g.remove()}this.containersCollection.add(h)},navMenuHandler:function(d){var c=b(d.target).closest(".menu-item");var e=this;c.find(".carbon-nav-menu-container").each(function(){var h=b(this);if(h.find(".carbon-container").length>0){return true}var f=h.data("json");var g=b.parseJSON(a.urldecode(f));e.containersCollection.add(g)})},lazyload:function(){if(_.isEmpty(a.lazyload)){return}for(var d in a.lazyload){var c=a.lazyload[d];if(!c.rendered&&a.isElementInViewport(c.$el)){c.trigger("field:rendered")}}}});a.template=_.memoize(function(e){var d;var c={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g};return function(h){var f=b("#crb-tmpl-"+e);var g=f.html()||"";g=b.trim(g);if(!f.length||!g){b.error('Cannot find the Backbone template for the following element: "'+e+'"')}d=d||_.template(g,null,c);return d(h)}});a.isElementInViewport=function(c){if(!c.is(":visible")){return false}var d=c[0].getBoundingClientRect();return(d.bottom>=0&&d.right>=0&&d.top<=b(window).height()&&d.left<=b(window).width())};a.urldecode=function(c){return decodeURIComponent((c+"").replace(/%(?![\da-f]{2})/gi,function(){return"%25"}).replace(/\+/g,"%20"))};a.docCookies={getItem:function(c){if(!c){return null}return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(c).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(f,i,e,d,c,g){if(!f||/^(?:expires|max\-age|path|domain|secure)$/i.test(f)){return false}var h="";if(e){switch(e.constructor){case Number:h=e===Infinity?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+e;break;case String:h="; expires="+e;break;case Date:h="; expires="+e.toUTCString();break}}document.cookie=encodeURIComponent(f)+"="+encodeURIComponent(i)+h+(c?"; domain="+c:"")+(d?"; path="+d:"")+(g?"; secure":"");return true},removeItem:function(e,d,c){if(!this.hasItem(e)){return false}document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(d?"; path="+d:"");return true},hasItem:function(c){if(!c){return false}return(new RegExp("(?:^|;\\s*)"+encodeURIComponent(c).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie)},keys:function(){var c=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);for(var e=c.length,d=0;d<e;d++){c[d]=decodeURIComponent(c[d])}return c}};a.init=function(){if(_.isUndefined(carbon_json)||_.isEmpty(carbon_json.containers)){return false}a.views.main=new a.main.View();a.views.main.setContainers()};b(document).ready(function(){a.init()})}(jQuery));