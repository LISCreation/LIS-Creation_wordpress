window.carbon=window.carbon||{};(function(b){var a=window.carbon;a.fields.Model=Backbone.Model.extend({defaults:{error:false,visible:true,force_required:false},initialize:function(){var c=["carbon-field","carbon-"+this.get("type")];var d=this.get("width");if(this.get("lazyload")){c.push("carbon-lazyload")}if(d&&_.isNumber(d)){c.push("has-width");c.push("width-"+d)}this.addClass(c)},addClass:function(e){if(!_.isArray(e)){e=[e]}var c=this.get("classes")||[];var d=_.union(c,e);if(d.length!==c.length){this.set("classes",d)}},isRequired:function(){return !!this.get("visible")&&(this.get("required")||this.get("force_required"))},validate:function(d,c){if(this.isRequired()&&!d.value){return crbl10n.message_required_field}}});a.fields.View=Backbone.View.extend({events:{"change :input":"sync"},templateVariables:{},hadErrors:false,initialize:function(){this.rendered=false;this.on("field:rendered",function(){this.rendered=true});this.listenTo(this.model,"change:height",this.equalizeHeight);this.listenTo(this.model,"change:classes",this.updateClass);this.listenTo(this.model,"change:error",this.toggleError);this.listenTo(this.model,"change:value",this.revalidate);this.listenTo(this.model,"change:visible",this.toggleVisibility);this.on("field:rendered",this.setWidth);this.on("field:rendered",this.toggleError);this.on("field:rendered",this.toggleVisibility);this.conditionalLogicInit()},conditionalLogicInit:function(){var c=this.model.get("conditional_logic");if(_.isEmpty(c)){return}this.model.set("visible",false);var d=new a.fields.ConditionalLogic({targetCollection:this.model.collection,rules:c.rules,relation:c.relation});this.listenTo(d,"change:valid",function(e){this.model.set("visible",e.get("valid"))});d.validate()},toggleVisibility:function(){var e=this.model.get("id");var d=this.model.get("visible");var c=this.$el.closest(".carbon-field");c.find(":input").attr("disabled",function(){return !d});c.toggle(d)},render:function(){var g=this.model.get("id");var e=this.model.get("type");var c=this.model.get("lazyload");var d=a.template(e);this.templateVariables=_.extend({},this.templateVariables,this.model.attributes,{model:this.model});this.trigger("field:beforeRender");var f=d(this.templateVariables);this.$el.html(f);if(c){a.lazyload[g]=this}else{this.trigger("field:rendered")}return this},sync:function(c){var e=b(c.currentTarget);var d=e.val();this.model.set("value",d)},revalidate:function(){if(this.model.isRequired()&&this.hadErrors){this.model.isValid();this.toggleError()}},toggleError:function(){var d=this.model.validationError;var f=this.$el.closest(".carbon-field");var e=f.find("> .carbon-error");var c=!!d;f.toggleClass("carbon-highlight",c);e.html(d);if(c){this.hadErrors=true}},setWidth:function(){var c=this.model.get("width");if(c&&_.isNumber(c)){this.$el.closest(".carbon-field").css("width",c+"%")}},updateClass:function(c){var d=c.get("classes");this.$el.closest(".carbon-field").addClass(d.join(" "))},layoutUpdated:function(){this.trigger("layoutUpdated")}});a.fields.Collection=Backbone.Collection.extend({model:function(d,c){var e=a.fields.Model[d.type];if(_.isUndefined(e)){e=a.fields.Model}return new e(d,c)}});a.fields.ConditionalLogic=Backbone.Model.extend({defaults:{targetCollection:new Backbone.Collection(),rules:[],relation:"AND",valid:false},initialize:function(){var c=this.getFields();this.listenTo(c,"change:value",this.validate)},validate:function(){var k=this.get("rules");var c=this.getFields();var g=this.get("relation");for(var e in k){var j=k[e];var d=this.getFieldByName(j.field);var h=d.get("value");j.valid=this.compare(h,j.value,j.compare)}var f=_.pluck(k,"valid");if(g==="AND"){valid=_.every(f)}if(g==="OR"){valid=_.some(f)}this.set("valid",valid)},getFields:function(){var e=this.get("rules");var c=this.get("targetCollection");var d=new Backbone.Collection();_.each(e,function(g){var f=c.findWhere({base_name:g.field});if(!f){b.error('ConditionalLogic: Field name "'+g.field+'" not found.')}d.add(f)});return d},getFieldByName:function(d){var c=this.getFields();return c.findWhere({base_name:d})},compare:function(d,c,e){switch(e){case"=":return d==c;case"!=":return d!=c;case">":return d>c;case"<":return d<c;case">=":return d>=c;case"<=":return d<=c;case"IN":return _.some(c,function(f){return f==d});case"NOT IN":return _.every(c,function(f){return f!=d});case"INCLUDES":return _.every([].concat(c),function(f){var g=(d===null)?"":d;return g.indexOf(f)!==-1});case"EXCLUDES":return _.every([].concat(c),function(f){var g=(d===null)?"":d;return g.indexOf(f)===-1})}}});a.fields.View.Map=a.fields.View.extend({events:{"update:marker":"updateMarker","keypress input.address":"updateAddress","click .carbon-map-search-button":"updateAddress"},initialize:function(){a.fields.View.prototype.initialize.apply(this);this.map=null;this.marker=null;this.listenTo(this.model,"change:address",this.geocodeAddress);this.listenTo(this.model,"change:lat change:lng",this.sync);this.listenTo(this.model,"change:lat change:lng change:zoom",this.updateInput);this.on("field:rendered",this.initMap)},initMap:function(){var h=this;var g=this.model;var c=this.map;var f=this.marker;var m=g.get("zoom");var j=g.get("lat");var k=g.get("lng");var d=new google.maps.LatLng(j,k);var l=this.$el;var e=l.find(".carbon-map-canvas");c=this.map=new google.maps.Map(e.get(0),{zoom:m,center:d,mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false});f=this.marker=new google.maps.Marker({position:d,map:c,draggable:true});google.maps.event.addListenerOnce(c,"click",this.enableScrollZoom);google.maps.event.addListenerOnce(c,"dragend",this.enableScrollZoom);google.maps.event.addListener(f,"dragend",function(n){h.model.set({lat:f.getPosition().lat(),lng:f.getPosition().lng()})});google.maps.event.addListener(c,"zoom_changed",function(){h.model.set("zoom",c.getZoom())});e.closest("div.widget").on("click.widgets-toggle",function(n){if(b(n.target).parents(".widget-inside").length>0){return}setTimeout(function(){google.maps.event.trigger(c,"resize");h.$el.trigger("update:marker")},1)})},sync:function(d){var e=d.get("lat");var c=d.get("lng");if(e&&c){d.set("value",e+","+c)}},updateMarker:function(e){var f=this.model.get("lat");var c=this.model.get("lng");var d=new google.maps.LatLng(f,c);if(this.marker){this.marker.setPosition(d);this.map.setCenter(d);google.maps.event.trigger(this.map,"zoom_changed")}},updateAddress:function(f){var e=13;if(f.type==="keypress"&&f.keyCode!==e){return}var d=this.model.get("name");var g=this.$(':input[name="'+d+'[address]"]');var c=g.val();this.model.set("address",c);f.preventDefault()},updateInput:function(d){var c=d.get("name");for(var e in d.changed){if(!d.changed.hasOwnProperty(e)){continue}var g=this.$(':input[name="'+c+"["+e+']"]');var f=d.changed[e];if(g.length){g.val(f)}}},geocodeAddress:function(d){var f=this;var c=d.get("address");var e=new google.maps.Geocoder();if(!c){return false}if(coords=c.match(/^(-?\d{1,3}\.\d+),\s?(-?\d{1,3}\.\d+)$/)){d.set({lat:parseFloat(coords[1]),lng:parseFloat(coords[2])});this.$el.trigger("update:marker");return true}e.geocode({address:c},function(h,g){if(g==google.maps.GeocoderStatus.OK){var j=h[0].geometry.location;d.set({lat:j.lat(),lng:j.lng()});f.$el.trigger("update:marker")}else{if(g==="ZERO_RESULTS"){alert(crbl10n.geocode_zero_results)}else{alert(crbl10n.geocode_not_successful+g)}}})},enableScrollZoom:function(){this.setOptions({scrollwheel:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE}})}});a.fields.View.RichText=a.fields.View.extend({initialize:function(){a.fields.View.prototype.initialize.apply(this);this.active=false;this.on("field:rendered",this.initEditor);this.on("sortstart",this.disableEditor);this.on("sortstop",this.enableEditor)},initEditor:function(){if(_.isUndefined(tinyMCEPreInit)||_.isUndefined(tinymce)){return false}var j=this.$("textarea.wp-editor-area");var h=this.get_mceInit();var g=this.get_qtInit();var d=this.model.get("value");tinyMCEPreInit.mceInit[h.id]=h;tinyMCEPreInit.qtInit[g.id]=g;if(!this.active){try{if(d){d=switchEditors.pre_wpautop(d);d=switchEditors.wpautop(d);j.val(d)}this.mediaButtonsInit();setTimeout(function(){tinymce.init(h)},0);var c=quicktags(g);this.textButtonsInit(c);this.active=true}catch(f){console.log(f)}}},get_mceInit:function(){var d=this.$el;var f=this.model.get("id");var e=b.extend({},tinyMCEPreInit.mceInit.carbon_settings);var c=a.views.main.$body.hasClass("touchscreen");e.selector="#"+f;e.id=f;e.elements=f;if(tinymce.majorVersion<4){e.setup=function(g){g.onInit.add(function(h,j){b(h.getBody()).on("blur",function(){h.save();d.find("textarea").trigger("change")})})}}else{e.setup=function(g){g.on("blur",function(h){g.save();d.find("textarea").trigger("change")})}}e.wp_autoresize_on=c?false:true;return e},get_qtInit:function(){var c=b.extend({},tinyMCEPreInit.qtInit.carbon_settings);c.id=this.model.get("id");return c},mediaButtonsInit:function(){var c=this.model.get("id");this.$(".wp-media-buttons .button:not([data-editor])").each(function(){b(this).attr("data-editor",c)})},textButtonsInit:function(d){var j=",strong,em,link,block,del,ins,img,ul,ol,li,code,more,close,";var f=d.canvas;var e=d.name;var h=d.settings;var k={};var g="";var c="";if(h.buttons){c=","+h.buttons+","}for(i in edButtons){if(!edButtons[i]){continue}id=edButtons[i].id;if(c&&j.indexOf(","+id+",")!==-1&&c.indexOf(","+id+",")===-1){continue}if(!edButtons[i].instance||edButtons[i].instance===inst){k[id]=edButtons[i];if(edButtons[i].html){g+=edButtons[i].html(e+"_")}}}if(c&&c.indexOf(",fullscreen,")!==-1){k.fullscreen=new qt.FullscreenButton();g+=k.fullscreen.html(e+"_")}if("rtl"===document.getElementsByTagName("html")[0].dir){k.textdirection=new qt.TextDirectionButton();g+=k.textdirection.html(e+"_")}d.toolbar.innerHTML=g;d.theButtons=k},disableEditor:function(){if(!this.active){return false}try{var f=this.model.get("id");var c=tinyMCE.get(f);if(!c){b.error("RichText Field - tinyMCE editor not found.")}c.save();c.destroy()}catch(d){console.log(d)}},enableEditor:function(){if(!this.active){return false}var c=this.$(".carbon-wysiwyg");if(c.hasClass("tmce-active")&&window.switchEditors){var d=this.model.get("id");switchEditors.go(d,"tmce")}}});a.fields.View.Date=a.fields.View.extend({initialize:function(){a.fields.View.prototype.initialize.apply(this);this.on("field:rendered",this.initDatePicker)},initDatePicker:function(){var f=this.$(".carbon-datepicker");var c=this.$(".carbon-datepicker-trigger");var e=this.model.get("options");var d={dateFormat:"yy-mm-dd",changeMonth:true,changeYear:true,hideIfNoPrevNext:true,beforeShow:function(g,h){b("#ui-datepicker-div").addClass("carbon-jquery-ui")}};b.extend(d,e);f.datepicker(d);c.on("click",function(g){f.focus();g.preventDefault()})}});a.fields.View.Color=a.fields.View.extend({events:_.extend({},a.fields.View.prototype.events,{"click .pickcolor":"focusField","focus input.carbon-color-field":"showColorPicker","blur input.carbon-color-field":"hideColorPicker"}),initialize:function(){a.fields.View.prototype.initialize.apply(this);this.on("field:rendered",this.initColorPicker)},initColorPicker:function(){var e=this;var d=this.$field=this.$("input.carbon-color-field");var c=this.model.get("value");e.setColor(c);d.iris({palettes:true,change:function(f,g){e.setColor(g.color.toString())}});d.on("change",function(){e.setColor(b(this).val())})},setColor:function(c){var e=this;var d=/^#([0-9A-F]{3}){1,2}$/i.test(c);if(c&&!d){this.$field.addClass("error").val(this.$field.iris("color"));setTimeout(function(){e.$field.removeClass("error")},100)}this.$(".carbon-color-preview").css("background-color",c).parent().toggleClass("has-color",!!c)},focusField:function(){this.$field.focus()},showColorPicker:function(){this.$field.iris("show")},hideColorPicker:function(){var c=this.$field;setTimeout(function(){if(!b(document.activeElement).closest(".iris-picker").length){c.iris("hide");c.trigger("change")}else{c.focus()}})}});a.fields.Model.Select=a.fields.Model.extend({initialize:function(){a.fields.Model.prototype.initialize.apply(this);var e=this;var d=this.get("value");var c=this.get("options")||[];if(!d){b.each(c,function(f,g){e.set("value",g.value);return false})}},validate:function(d,c){var e=d.value;if(this.isRequired()&&(!e||e==="0")){return crbl10n.message_choose_option}}});a.fields.Model.GravityForm=a.fields.Model.Select.extend({initialize:function(){a.fields.Model.Select.prototype.initialize.apply(this)},});a.fields.View.GravityForm=a.fields.View.extend({initialize:function(){a.fields.View.prototype.initialize.apply(this);this.listenTo(this.model,"change:value",this.render)}});a.fields.Model.Sidebar=a.fields.Model.Select.extend({initialize:function(){this.setSidebarOptions();a.fields.Model.Select.prototype.initialize.apply(this)},setSidebarOptions:function(){var c=this.get("options");var d=this.get("excluded_sidebars");var e=[];a.collections.sidebars.each(function(f){var g=f.get("name");var j=f.get("id");var h={name:g,value:j};if(typeof(d)!=="undefined"&&(d.indexOf(g)>-1||d.indexOf(j)>-1)){return}if(!!_.findWhere(c,h)){return}e.push(h)});this.set("options",_.union(e,c))},validate:function(d,c){return a.fields.Model.prototype.validate.apply(this,arguments)}});a.fields.View.Sidebar=a.fields.View.extend({events:_.extend({},a.fields.View.prototype.events,{"change select":"addNewSidebar"}),initialize:function(){a.fields.View.prototype.initialize.apply(this);this.listenTo(a.collections.sidebars,"add",this.addSidebarOption)},addSidebarOption:function(d){var e=d.get("name");var c=this.$("select");if(!e){return}b('<option value="'+_.escape(e)+'">'+e+"</option>").insertBefore(c.find("option:last"))},addNewSidebar:function(e){var c=this.$("select");if(c.val()!=="new"){return true}var d=b.trim(window.prompt(crbl10n.enter_name_of_new_sidebar));if(d){var f=a.collections.sidebars.findWhere({name:d});if(!f){a.collections.sidebars.add({name:d})}c.find('option[value="'+_.escape(d)+'"]').prop("selected",true)}else{c.find("option:first").prop("selected",true)}c.trigger("change")}});a.fields.Model.ChooseSidebar=a.fields.Model.Sidebar.extend({setSidebarOptions:function(){}});a.fields.View.ChooseSidebar=a.fields.View.Sidebar.extend({initialize:function(){a.fields.View.Sidebar.prototype.initialize.apply(this);this.stopListening(a.collections.sidebars,"add",this.addSidebarOption)},addNewSidebar:function(e){var c=b(e.target);if(c.val()!=="new"){return true}var d=b.trim(window.prompt(crbl10n.enter_name_of_new_sidebar));if(d){var f=b('<option value="'+_.escape(d)+'">'+d+"</option>").insertBefore(c.find("option:last"));c.find("option").prop("selected",false);f.prop("selected",true)}else{c.find("option:first").prop("selected",true)}c.trigger("change")}});a.fields.View.File=a.fields.View.extend({events:_.extend({},a.fields.View.prototype.events,{"click .c2_open_media":"openMedia","click .carbon-file-remove":"removeFile"}),initialize:function(){a.fields.View.prototype.initialize.apply(this);this.on("field:beforeRender",this.loadDescriptionTemplate);this.listenTo(this.model,"change:value",this.updateInput);this.listenTo(this.model,"change:value",this.updateView);this.listenTo(this.model,"change:thumb_url",this.updateThumb)},loadDescriptionTemplate:function(){var d=this.model.get("type");var c=a.template(d+"-Description");_.extend(this.templateVariables,{description:c(this.templateVariables)})},openMedia:function(d){var j=this;var l=this.model.get("type");var g=this.model.get("window_button_label");var n=this.model.get("window_label");var c=this.model.get("type_filter");var f=this.model.get("value_type");var m=this.model.get("value");var h={};var e=function(p){var q="";if(p.type==="image"&&p.sizes){var o=p.sizes.thumbnail||p.sizes.full;q=o.url}return q};h[l]=wp.media.frames.crbMediaField=wp.media({title:n?n:crbl10n.title,library:{type:c},button:{text:g},multiple:true});var k=h[l];k.on("select",function(){var o=k.state().get("selection").toJSON();var p=o.shift();_.each(o,function(s){var t=e(s);if(!t){t=j.model.get("default_thumb_url")}j.model.set("multiply",{value:s[f],file_type:s.type,file_name:s.filename,thumb_url:t})});var q=p[f];var r=e(p);if(!r){r=j.model.get("default_thumb_url")}this.model.set("file_type",p.type);this.model.set("file_name",p.filename);this.model.set("value",q);this.model.set("thumb_url",r);this.trigger("media:updated",p)},this).on("open",function(){if(!m){return}var p=wp.media.attachment(m);var o=k.state().get("selection");p.fetch();o.set(p?[p]:[])});k.open();d.preventDefault()},updateInput:function(c){var e=this.$("input.carbon-file-field");var d=c.get("value");if(!d){c.set("url","")}e.val(d).trigger("change")},updateView:function(c){var d=c.get("value");var e=c.get("file_name");this.$(".carbon-attachment-file-name").html(e);this.$(".carbon-description").toggleClass("hidden",!d)},updateThumb:function(c){var d=c.get("thumb_url");this.$("img.thumbnail-image").attr("src",d);this.$(".carbon-attachment-preview").toggleClass("hidden",!d)},removeFile:function(c){this.$(".carbon-description").addClass("hidden");this.$(".carbon-attachment-preview").addClass("hidden");this.$("input.carbon-file-field").attr("value","").trigger("change");this.$(".carbon-attachment-file-name").html("");this.model.set("file_name","");this.model.set("thumb_url","")}});a.fields.View.Image=a.fields.View.File.extend({initialize:function(){a.fields.View.File.prototype.initialize.apply(this);this.model.addClass("carbon-File")},});a.fields.View.Checkbox=a.fields.View.extend({sync:function(c){var d=this.$('input[type="checkbox"]:checked').val()||"";this.model.set("value",d)}});a.fields.Model.Set=a.fields.Model.extend({validate:function(d,c){if(this.isRequired()&&_.isEmpty(d.value)){return crbl10n.message_required_field}}});a.fields.View.Set=a.fields.View.extend({initialize:function(){a.fields.View.prototype.initialize.apply(this);this.on("field:rendered",this.showAll)},showAll:function(){this.$("a.carbon-set-showall").one("click",function(c){b(this).parent().hide().siblings().show();c.preventDefault()})},sync:function(c){var d=[];this.$('input[type="checkbox"]:checked').each(function(){d.push(b(this).val())});this.model.set("value",d)}});a.fields.Model.Relationship=a.fields.Model.extend({validate:function(d,c){if(this.isRequired()&&_.isEmpty(d.value)){return crbl10n.message_required_field}}});a.fields.View.Relationship=a.fields.View.extend({disabledClass:"inactive",events:{"click .carbon-relationship-left .carbon-relationship-list a":"addItem","click .carbon-relationship-right .carbon-relationship-list a":"removeItem","keypress .carbon-relationship-search":"searchFieldKeyPress","keyup .carbon-relationship-search":"searchFilter","click a .edit-link":"editLink"},initialize:function(){a.fields.View.prototype.initialize.apply(this);this.selectedItems=[];this.on("field:rendered",this.initRelationship);this.on("field:relationship:afterAdd field:relationship:afterRemove field:relationship:afterSort",this.sync)},initRelationship:function(){var g=this;var f=this.model.get("allow_duplicates");var d=this.model.get("name");var c=a.views.main.$body.hasClass("touchscreen");this.$leftList=this.$(".carbon-relationship-left .carbon-relationship-list");this.$rightList=this.$(".carbon-relationship-right .carbon-relationship-list");this.$searchBox=this.$(".carbon-relationship-left .search-field");this.$rightList.find('input[name^="'+d+'["]').each(function(){g.selectedItems.push(this.value);if(!f){g.$leftList.find('a[data-value="'+this.value+'"]').parent().addClass(g.disabledClass)}});var e={axis:"y",items:"> li",forceHelperSize:true,forcePlaceholderSize:true,placeholder:"ui-placeholder-highlight",scroll:true,update:function(){g.trigger("field:relationship:afterSort")}};if(c){e.handle=".mobile-handle"}this.$rightList.sortable(e);this.trigger("field:initialized")},sync:function(){var d=this;var c=[];this.$rightList.find("> li > a").each(function(){var f=b(this);var e=d.buildItem(f.data("item-id"),f.data("item-title"),f.data("item-type"),f.data("item-subtype"),f.data("item-label"));c.push(e)});this.model.set("value",c)},addItem:function(c){var n=b(c.target);if(!n.is("a")){n=n.closest("a")}var m=this.model.get("allow_duplicates");var h=this.model.get("max");var d=n.data("item-id");var g=n.data("item-type");var f=n.data("item-subtype");var k=n.data("item-label");var j=n.data("item-title");var l=this.buildItemValue(d,g,f);var e=a.template(this.model.get("type")+"_item");var o;if(!m&&b.inArray(l,this.selectedItems)>-1){return false}if(h>0&&this.selectedItems.length>=h){alert(crbl10n.max_num_items_reached.replace("%s",h));return false}this.setSelectedItemsLabel(n,this.selectedItems.length,"add");this.trigger("field:relationship:beforeAdd");if(!m){n.parent().addClass(this.disabledClass)}o=e({name:this.model.get("name"),item:this.buildItem(d,j,g,f,k)});this.model.set("nextfieldIndex",this.model.get("nextfieldIndex")+1);this.$rightList.append(o);this.selectedItems.push(l);this.trigger("field:relationship:afterAdd");c.preventDefault()},removeItem:function(e){var d=b(e.target);if(!d.is("a")){d=d.closest("a")}var f=d.siblings("input").val();var c=b.inArray(f,this.selectedItems);var g=this.model.get("allow_duplicates");if(c<0){return false}this.trigger("field:relationship:beforeRemove");this.setSelectedItemsLabel(d,this.selectedItems.length,"remove");this.selectedItems.splice(c,1);d.parent().remove();if(!g){this.$leftList.find('a[data-value="'+f+'"]').parent().removeClass(this.disabledClass)}this.trigger("field:relationship:afterRemove");e.preventDefault()},setSelectedItemsLabel:function(g,f,h){var e=g.parents(".carbon-relationship-container").find(".selected-items-container .selected-counter");var d=e.siblings(".selected-label");var c;if(h==="add"){f++}else{f--}if(f==1){c=d.data("single-label")}else{c=d.data("plural-label")}d.html(c);e.html(f)},editLink:function(d){var c=b(d.target).data("href");if(typeof c!="undefined"){d.preventDefault();d.stopPropagation();window.open(b(d.target).data("href"),"_blank")}},searchFieldKeyPress:function(c){if(c.which==13){c.preventDefault()}},searchFilter:function(d){var c=b(d.target);var e=c.val();this.trigger("field:relationship:beforeFilter");this.$leftList.find('li a:containsInsensitive("'+e+'")').show();this.$leftList.find('li a:not(:containsInsensitive("'+e+'"))').hide();this.trigger("field:relationship:afterFilter");d.preventDefault()},buildItem:function(g,f,e,c,d){return{id:g,title:f,type:e,subtype:c,label:d,fieldIndex:this.model.get("nextfieldIndex")}},buildItemValue:function(e,d,c){return e+""}});a.fields.Model.Association=a.fields.Model.Relationship.extend({initialize:function(){a.fields.Model.Relationship.prototype.initialize.apply(this);this.addClass("carbon-Relationship")}});a.fields.View.Association=a.fields.View.Relationship.extend({buildItemValue:function(f,e,c){var d=":";return e+d+c+d+f}});a.fields.View.Time=a.fields.View.extend({events:function(){return _.extend({},a.fields.View.prototype.events,{"click .carbon-timepicker-trigger":"showTimepicker"})},initialize:function(){a.fields.View.prototype.initialize.apply(this);this.on("field:rendered",this.initTimepicker)},initTimepicker:function(){var g=this.$el.find(".carbon-timepicker");var c=this.$el.find(".carbon-timepicker-trigger");var f=this.model.get("timepicker_type");var j=this.model.get("interval_step");var h=this.model.get("restraints");var d=this.model.get("timepicker_options");var e={timeFormat:this.model.get("time_format"),showTime:false,changeMonth:true,changeYear:true,beforeShow:function(k,l){b("#ui-datepicker-div").addClass("carbon-jquery-ui")}};b.extend(e,j,h,d);g[f](e)},showTimepicker:function(c){this.$el.find(".carbon-timepicker").trigger("focus");c.preventDefault()}});a.fields.Model.RadioImage=a.fields.Model.Select;a.fields.View.DateTime=a.fields.View.Time;a.fields.Model.Complex=a.fields.Model.extend({defaults:_.extend({},a.fields.Model.prototype.defaults,{index:0,force_required:true}),getGroupByName:function(e){var d=this.get("groups")||[];var g=null;for(var f=0;f<d.length;f++){var c=d[f];if(c.hasOwnProperty("name")&&c.name==e){g=c;break}}return g},isTabbed:function(){return/^tabbed/.test(this.get("layout"))},validate:function(h,l){var g=a.views[this.get("id")];if(_.isUndefined(g)){return}var d=this.get("min");var c=g.groupsCollection.length;var k=d<=0||!c||d<=c;var f=true;_.each(g.groupsCollection.models,function(m){if(!m.isValid()){f=false}});if(!f){return crbl10n.message_form_validation_failed}if(!c&&this.get("required")){return crbl10n.message_required_field}if(!k){var e=this.get("labels");var j=d==1?e.singular_name:e.plural_name;return crbl10n.complex_min_num_rows_not_reached.replace("%d",d).replace("%s",j.toLowerCase())}}});a.fields.View.Complex=a.fields.View.extend({events:{"click > .carbon-subcontainer > .carbon-actions a":"addEntry","click > .carbon-subcontainer > .groups-wrapper > .group-tabs-nav-holder > .carbon-actions a":"addEntry","click > .carbon-subcontainer > .carbon-empty-row a":"addEntry","click > .carbon-subcontainer > .groups-wrapper > .group-tabs-nav-holder > .group-tabs-nav > li > a":"showGroupTab"},initialize:function(){a.fields.View.prototype.initialize.apply(this);this.multipleGroups=this.model.get("multiple_groups");this.isTabbed=this.model.isTabbed();this.groupsCollection=new a.fields.Collection.Group;this.groupsCollection.limit=this.model.get("max");this.groupsCollection.comparator="order";this.listenTo(this.groupsCollection,"add",this.setGroupOrder);this.listenTo(this.groupsCollection,"add",this.setGroupIndex);this.listenTo(this.groupsCollection,"remove",this.revalidate);this.listenTo(this.groupsCollection,"add remove",this.checkMax);this.listenTo(this.groupsCollection,"add remove",this.toggleIntroRow);this.listenTo(this.groupsCollection,"add remove",this.sortGroups);this.listenTo(this.groupsCollection,"sort",this.reorderGroups);this.listenTo(this.groupsCollection,"add",this.setGroupID);this.listenTo(this.groupsCollection,"add",this.renderGroup);if(this.isTabbed){this.listenTo(this.groupsCollection,"add",this.renderGroupTab);this.listenTo(this.groupsCollection,"remove",this.removeGroupTab)}this.on("propagate",function(c){a.containers.View.prototype.eventPropagator.apply(this,[this.groupsCollection,c])});this.on("field:rendered",this.setDOMVariables);this.on("field:rendered",this.setGroups);this.on("field:rendered",function(){this.listenTo(this.groupsCollection,"change",this.sync)});this.on("field:rendered",this.sortable);if(this.multipleGroups){this.on("field:rendered",this.hideGroupsListListener)}if(this.isTabbed){this.model.addClass("carbon-Complex-tabbed");this.on("field:rendered",this.initGroupTabs)}},sync:function(d,f){var c=["collapsed"];for(var e=0;e<c.length;e++){if(d.changed.hasOwnProperty(c[e])){return false}}this.model.set("value",this.groupsCollection.toJSON())},setGroupOrder:function(d,e){var c=d.get("order");if(c===null){c=Math.max(0,e.length-1)}d.set("order",c)},checkMax:function(d,f){var c=this.model.get("max");var e=f.length>=c;if(c<=0){return false}this.$el.toggleClass("max-reached",e);this.$actions.toggle(!e)},setGroupIndex:function(d,e){var c=this.model.get("index");d.set("index",c);this.model.set("index",c+1)},toggleIntroRow:function(){this.$introRow.toggleClass("carbon-empty-row-visible",this.groupsCollection.length===0)},sortGroups:function(){this.groupsCollection.sort()},reorderGroups:function(c){_.each(this.groupsCollection.models,function(d,e){d.set("order",e)})},setDOMVariables:function(){this.$tabsNav=this.$(".group-tabs-nav");this.$actions=this.$(".carbon-actions");this.$introRow=this.$(".carbon-empty-row");this.$groupsList=this.$actions.find("ul");this.$groupsHolder=this.$(".carbon-groups-holder")},setGroups:function(){var d=this;var c=this.model.get("value");_.each(c,function(e){e.collapsed=d.model.get("collapsed");d.groupsCollection.add(e,{sort:false})})},sortable:function(){var c=this;this.$groupsHolder.sortable({items:"> .carbon-group-row",handle:".carbon-drag-handle",placeholder:"carbon-group-row ui-placeholder-highlight",start:function(d,e){c.$groupsHolder.addClass("carbon-container-shrank");e.item.groupID=e.item.data("group-id");e.item.groupView=a.views[e.item.groupID];e.item.groupModel=e.item.groupView.model;e.item.groupsCollection=e.item.groupModel.collection;e.item.groupCollapsedState=e.item.groupModel.get("collapsed");e.item.groupModel.set("collapsed",true);e.item.groupView.trigger("sortable",d);b(this).sortable("refresh")},stop:function(d,e){c.$groupsHolder.removeClass("carbon-container-shrank");e.item.groupModel.set("collapsed",e.item.groupCollapsedState);e.item.groupView.trigger("sortable",d)},update:function(e,g){var d=g.item.index();var f=g.item.groupModel.get("order");g.item.groupModel.set("order",d);g.item.groupsCollection.moveTo(f,d).sort();g.item.groupView.trigger("sortable",e)}})},addEntry:function(d){var c=b(d.target);var f=c.data("group");if(f){this.addNewGroup(f)}else{if(this.multipleGroups){this.$groupsList.toggle();this.$tabsNav.closest(".group-tabs-nav-holder").toggleClass("active");var e=this.$groupsHolder.offset().left+this.$groupsHolder.width()-this.$actions.offset().left-this.$groupsList.width();this.$groupsList.toggleClass("right-aligned",0>e)}else{this.$actions.find("a.button").eq(0).trigger("click")}}d.preventDefault()},hideGroupsListListener:function(){var d=this;var c=this.$introRow.find("a");a.views.main.$body.on("click",function(e){var f=b(e.target).parent().hasClass("carbon-button")||e.target===c[0];if(!f){d.$groupsList.hide();d.$tabsNav.closest(".group-tabs-nav-holder").removeClass("active")}})},addNewGroup:function(c){if(_.isString(c)){c=this.model.getGroupByName(c)}this.groupsCollection.add(c,{sort:false})},setGroupID:function(d){var c=d.get("index");var e=this.model.get("id");var f=e+"-"+c;d.set("id",f)},renderGroup:function(d){var f=this;var e=d.get("id");var c=a.views[e]=new a.fields.View.Complex.Group({el:this.$groupsHolder,model:d});c.on("layoutUpdated",function(){f.trigger("layoutUpdated")});c.render(this.model);return this},renderGroupTab:function(c){var e=c.get("id");var d=c.get("order");var h=a.views[e];var f=a.template("Complex-Group-Tab-Item");var j=f(h.templateVariables);var g=this.$tabsNav.children();if(g.length){g.eq(d-1).after(j)}else{this.$tabsNav.append(j)}},initGroupTabs:function(){this.listenTo(this.groupsCollection,"add",this.switchToGroupTab);this.sortableGroupTabs();this.switchToFirstGroupTab()},sortableGroupTabs:function(){var c=this.$tabsNav;var f=this.$groupsHolder;var d=this.model.get("layout");var e=d==="tabbed-vertical";c.sortable({axis:e?"y":"xy",items:".group-tab-item",placeholder:"group-tab-item ui-placeholder-highlight",handle:e?".group-handle":false,forcePlaceholderSize:true,start:function(g,h){c.addClass("carbon-container-shrank");h.item.groupID=h.item.data("group-id");h.item.groupView=a.views[h.item.groupID];h.item.groupModel=h.item.groupView.model;h.item.groupsCollection=h.item.groupModel.collection;h.item.groupView.trigger("sortable",g);b(this).sortable("refresh")},stop:function(g,h){c.removeClass("carbon-container-shrank");h.item.groupView.trigger("sortable",g)},update:function(l,n){var g=n.item.index();var m=n.item.groupModel.get("order");var j=m>g?g-1:g;var k=n.item.groupView.$el;var h=f.children();n.item.groupModel.set("order",g);n.item.groupsCollection.moveTo(m,g).sort();if(j<0){k.insertBefore(h.first())}else{k.insertAfter(h.eq(j))}n.item.groupView.trigger("sortable",l)}})},switchToFirstGroupTab:function(){var c=this.groupsCollection.first();if(c){this.switchToGroupTab(c)}},switchToPreviousGroupTab:function(d){var e=d.get("order")-1;var c=this.groupsCollection.findWhere({order:e});if(c){this.switchToGroupTab(c)}else{this.switchToFirstGroupTab()}},switchToGroupTab:function(d){var e=d.get("id");var c=this.$groupsHolder.children();var f=a.views[e].$el;var h=this.$tabsNav.find(".group-tab-item");var g=h.filter('[data-group-id="'+e+'"]');h.removeClass("active");c.removeClass("active");g.addClass("active");f.addClass("active")},removeGroupTab:function(c){var d=c.get("id");var e=this.$tabsNav.find('.group-tab-item[data-group-id="'+d+'"]');e.remove();this.switchToPreviousGroupTab(c)},showGroupTab:function(d){var f=b(d.currentTarget).closest(".group-tab-item");var c=f.data("group-id");var e=this.groupsCollection.get(c);this.switchToGroupTab(e);d.preventDefault()}});a.fields.Model.Complex.Group=Backbone.Model.extend({defaults:{order:null,index:null,collapsed:false},initialize:function(){var c=this.get("fields");_.each(c,function(d){if(d.hasOwnProperty("old_id")&&d.hasOwnProperty("old_name")){d.id=d.old_id;d.name=d.old_name;delete d.old_id;delete d.old_name}});this.set("fields",c)},validate:function(d,c){return a.containers.Model.prototype.validate.apply(this,arguments)}});a.fields.View.Complex.Group=Backbone.View.extend({events:{"click .carbon-group-actions:first a.carbon-btn-remove":"removeGroup","click .carbon-group-actions:first a.carbon-btn-collapse":"collapseGroup","click .carbon-group-actions:first a.carbon-btn-duplicate":"duplicateGroup"},templateVariables:{},initialize:function(){this.on("group:rendered",this.afterRenderInit);this.listenTo(this.model,"change:order",this.updateOrderNumber);this.on("sortable",this.eventPropagator);this.on("propagate",function(c){a.containers.View.prototype.eventPropagator.apply(this,[this.fieldsCollection,c])});this.listenTo(this.model,"change:collapsed",this.toggleCollapse);this.fieldsCollection=new a.fields.Collection(this.model.get("fields"));this.listenTo(this.fieldsCollection,"add",this.updateFieldNameID);this.listenTo(this.fieldsCollection,"add",this.renderField);this.listenTo(this.fieldsCollection,"change",this.sync);this.listenTo(this.fieldsCollection,"change",this.updateLabel);this.listenTo(this.fieldsCollection,"change:multiply",this.multiplier);this.listenTo(this.model,"change:error",this.toggleGroupError)},multiplier:function(e){var d=e.get("multiply");var c=e.get("old_id");var h=this.model.collection;var g=this.model.get("name");var f=b.extend(true,{},this.complexModel.getGroupByName(g));_.each(f.fields,function(j){if(c!==j.id){return}_.each(_.keys(d),function(k){j[k]=d[k]})});h.add(f,{sort:false})},toggleCollapse:function(c){var d=c.get("collapsed");if(this.complexModel.isTabbed()){return}this.$el.toggleClass("collapsed",d)},toggleGroupError:function(c){var d=this.model.get("error");b('.group-tab-item[data-group-id="'+this.model.id+'"]').toggleClass("carbon-complex-group-has-error",d)},eventPropagator:function(c){_.each(this.fieldsCollection.models,function(e){var d=a.views[e.get("id")];if(d.hasOwnProperty("groupsCollection")){_.each(d.groupsCollection.models,function(f){var g=a.views[f.get("id")];g.trigger("sortable",c)})}d.trigger(c.type)})},sync:function(){this.model.set("fields",this.fieldsCollection.toJSON())},updateLabel:function(){if(!this.hasLabelTemplate()){return}var d=this.getLabelTemplate();var c=d||this.model.get("label");if(this.complexModel.isTabbed()){var e=this.getTabElement().find(".group-name")}else{var e=this.$("> .carbon-drag-handle .group-name")}e.html(c)},hasLabelTemplate:function(){return this.getLabelTemplate()!==null},updateFieldNameID:function(g){var k=g.get("id");var f=g.get("name");var e=this.model.get("index");var j=this.complexModel.get("name");var h=this.complexModel.get("id");var d=h+"-"+k+"-"+e;var c=j+"["+e+"]["+f+"]";g.set("old_id",k);g.set("old_name",f);g.set("id",d);g.set("name",c)},updateOrderNumber:function(c){var d=c.get("order");this.$("> .carbon-drag-handle .group-number").text(d+1);if(this.complexModel.isTabbed()){this.getTabElement().find(".group-number").text(d+1)}},getTabElement:function(){var e=this.complexModel.get("id");var d=a.views[e];var c=this.model.get("id");return d.$tabsNav.find('[data-group-id="'+c+'"]')},getLabelTemplate:function(){try{var c=a.template(this.model.get("group_id"));var d={_models:{}};_.each(this.fieldsCollection.models,function(e){var h=e.get("base_name");var g=e.get("value");d[h]=g;d._models[h]=e});return c(d)}catch(f){}},render:function(c){this.complexModel=c;this.complexView=a.views[c.get("id")];var e=this.model.get("order");var f=a.template("Complex-Group");this.templateVariables=_.extend({},this.templateVariables,this.model.attributes,{complex_id:this.complexModel.get("id"),complex_name:this.complexModel.get("name"),layout:this.complexModel.get("layout"),label_template:this.getLabelTemplate(),fields:this.fieldsCollection.toJSON()});this.trigger("group:beforeRender");var h=f(this.templateVariables);var g=this.$el;var d=g.children();this.setElement(h);this.$el.hide();if(d.length){d.eq(e-1).after(this.$el)}else{g.append(this.$el)}this.$el.fadeIn();this.trigger("group:rendered")},removeGroup:function(c){var d=this;this.undelegateEvents();this.$el.removeData().unbind();this.$el.addClass("removed").fadeOut(function(){d.remove();d.model.collection.remove(d.model)});c.preventDefault()},collapseGroup:function(c){var d=this.model.get("collapsed");this.model.set("collapsed",!d);c.preventDefault()},syncBeforeDuplicate:function(d){var c=b(":focus");if(c.length){c.trigger("change")}},duplicateGroup:function(e){this.syncBeforeDuplicate(e);var f=this.model.collection;var c=b.extend(true,{},this.model.attributes);c.id=null;c.collapsed=false;if(c.hasOwnProperty("fields")){c.fields=this.fieldsCollection.toJSON()}var d=new this.model.constructor(c);f.add(d);e.preventDefault()},afterRenderInit:function(){var c=this;this.toggleCollapse(this.model);this.fieldsCollection.each(function(d){c.fieldsCollection.trigger("add",d)})},setHelperClasses:function(e){var f=e.get("type");if(f==="Complex"){var d=this.complexModel.get("classes");var g=b.inArray("even",d)!==-1;var c=b.inArray("odd",d)!==-1;if(!g&&!c){this.complexModel.addClass("odd");c=true}if(g){e.addClass("odd")}else{if(c){e.addClass("even")}}}},renderField:function(c){a.containers.View.prototype.renderField.apply(this,arguments);this.setHelperClasses(c)}});a.fields.Collection.Group=Backbone.Collection.extend({model:a.fields.Model.Complex.Group,add:function(){if(this.limit>0&&this.length>=this.limit){return}Backbone.Collection.prototype.add.apply(this,arguments)},moveTo:function(e,d){var c=this.models.splice(e,1);this.models.splice(d,0,c[0]);this.trigger("move",[e,d]);return this}})}(jQuery));